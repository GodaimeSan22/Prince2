<script>
    let currentIdx = 0;
    let score = 0;
    let answered = false;
    let sessionQuestions = [];
    let timeLeft = 15 * 60; // 15 minutes in seconds
    let timerInterval;

    function initQuiz() {
        if (typeof questions === 'undefined' || questions.length === 0) {
            document.getElementById('q-text').innerHTML = "<span class='text-red-500'>Error:</span> questions.js not loaded.";
            return;
        }

        // Sprint Mode: Shuffle all and pick 15 random questions
        sessionQuestions = [...questions]
            .sort(() => Math.random() - 0.5)
            .slice(0, 15);

        startTimer();
        loadQuestion();
    }

    function startTimer() {
        const timerDisplay = document.getElementById('progress-text');
        timerInterval = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            // Update nav text: Current Question + Time Remaining
            timerDisplay.innerText = `Q: ${currentIdx + 1}/15 | TIME: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showResults();
            }
            timeLeft--;
        }, 1000);
    }

    function loadQuestion() {
        answered = false;
        const q = sessionQuestions[currentIdx];
        
        // Progress bar based on 15 questions
        document.getElementById('progress-bar').style.width = `${((currentIdx + 1) / 15) * 100}%`;
        
        document.getElementById('q-category').innerText = q.category;
        document.getElementById('q-text').innerText = q.question;
        document.getElementById('feedback-container').classList.add('hidden');
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        q.options.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option-card p-6 rounded-2xl cursor-pointer text-sm md:text-base font-medium flex gap-5 items-center bg-white/[0.02]';
            div.innerHTML = `
                <span class="w-8 h-8 rounded-xl bg-white/5 border border-white/5 flex items-center justify-center text-[10px] font-bold text-slate-500 flex-shrink-0 transition-colors">
                    ${String.fromCharCode(65 + i)}
                </span> 
                <span class="text-slate-300">${opt}</span>
            `;
            div.onclick = () => checkAnswer(i, div);
            container.appendChild(div);
        });
    }

    function checkAnswer(idx, element) {
        if(answered) return;
        answered = true;
        
        const q = sessionQuestions[currentIdx];
        const cards = document.querySelectorAll('.option-card');
        
        if(idx === q.correct) {
            element.classList.add('correct');
            element.querySelector('span:first-child').classList.add('bg-green-500/20', 'text-green-500', 'border-green-500/40');
            score++;
        } else {
            element.classList.add('wrong');
            element.querySelector('span:first-child').classList.add('bg-red-500/20', 'text-red-500', 'border-red-500/40');
            cards[q.correct].classList.add('correct');
            cards[q.correct].querySelector('span:first-child').classList.add('bg-green-500/20', 'text-green-500', 'border-green-500/40');
        }
        
        document.getElementById('rationale-box').innerHTML = `
            <div class="flex items-center gap-2 mb-3">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                <strong class="text-blue-500 font-bold uppercase tracking-[0.2em] text-[10px]">Official Rationale</strong>
            </div>
            <div class="text-slate-200">${q.rationale}</div>
        `;
        document.getElementById('feedback-container').classList.remove('hidden');
        
        setTimeout(() => {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }, 150);
    }

    function nextQuestion() {
        currentIdx++;
        if(currentIdx < sessionQuestions.length) {
            loadQuestion();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            clearInterval(timerInterval);
            showResults();
        }
    }

    function showResults() {
        document.getElementById('quiz-container').classList.add('hidden');
        document.getElementById('progress-bar').parentElement.classList.add('hidden');
        document.getElementById('results-screen').classList.remove('hidden');
        document.getElementById('progress-text').innerText = "Sprint Finished";
        
        const percent = Math.round((score / sessionQuestions.length) * 100);
        const passed = percent >= 60;
        
        document.getElementById('score-text').innerHTML = `
            <span class="block text-7xl font-black text-white mb-4 tracking-tighter">${percent}%</span>
            Correct: <span class="text-white font-bold">${score}</span> / 15<br>
            <div class="mt-8">
                <span class="px-6 py-2 rounded-full border ${passed ? 'border-green-500 text-green-500 bg-green-500/5' : 'border-red-500 text-red-500 bg-red-500/5'} font-bold uppercase text-[10px] tracking-widest">
                    ${passed ? 'Pass: Great Sprint!' : 'Fail: Review Concepts!'}
                </span>
            </div>
        `;
    }

    window.onload = initQuiz;
</script>